ifdef::backend-pdf[]
= Open Energy Management System
include::_attributes.adoc[]
endif::[]
ifndef::backend-pdf[]
include::_attributes.adoc[]
endif::[]
:source-highlighter: highlight.js
:icons: font
:idprefix:
:idseparator: -
:table-caption!:

== OpenEMS Edge

OpenEMS Edge is the core component of the energy management that runs on-site and is responsible for communicating with and controling of external hardware like battery systems, inverters, meters and so on.

=== Architecture

The OpenEMS Edge software architecture is carefully designed to abstract device communication and control algorithms in a way to provide maximum flexibility, predictability and stability, while simplifying the process of implementing new components.

==== Input-Process-Output

OpenEMS Edge is built around the well-known IPO (input-process-output) model which defines the internal execution cycle.

.Input-Process-Output model
image::input-process-output.png[Input-Process-Output model]

Input::
During the input phase all relevant information - e.g. the current 'state of charge' of a battery - is collected and provided as a *process image*. This process image is guaranteed to never change during the cycle.

Process::
The process phase runs algorithms and tasks based on the process image - e.g. an algorithm uses the 'state of charge' information to evaluate whether a digital output should be turned on.

Output::
The output phase takes the results from the process phase and applies it - e.g. it turns the digital output on or off.

==== Scheduler and Controller

During the 'process' phase different algorithms (Controllers) might try to access the same resources - e.g. two Controllers try to switch the same digital output. It is therefor necessary to prioritize their execution and restrict access according to priority.

OpenEMS Edge uses Scheduler implementations to receive a sorted list of Controllers. The Controllers are then executed in order. Later executed Controllers are not allowed to overwrite a previously written result. 

.IPO model with Scheduler and Controllers
image::input-process-scheduler-output.png[IPO model with Scheduler and Controllers]

==== Cycle

The input-process-output model in OpenEMS Edge is executed in a Cycle - implemented by the link:../io.openems.edge.core/src/io/openems/edge/cycle/Cycle.java[Cycle component icon:code[]]). It handles the setting of a process image in the input phase and executes the Controllers in the process phase. Furthermore it emits Cycle Events that can be used in other Components to synchronize with the Cycle.  

.OpenEMS Edge Cycle
image::edge-cycle.png[OpenEMS Edge Cycle]

==== Asynchronous threads and Cycle synchronization

Communication with external hardware and services needs to be executed in asynchronous threads to not block the system. At the same time, those threads need to synchronize with the Cycle.

The following example shows, how the link:../io.openems.edge.bridge.modbus/src/io/openems/edge/bridge/modbus/AbstractModbusBridge.java[Modbus implementation icon:code[]] uses Cycle Events to synchronize with the Cycle:

.Synchronize Cycle with Modbus read/write 
image::cycle-modbus.png[Synchronize Cycle with Modbus read/write]

==== Architecture scheme

The following scheme shows the abstraction of hardware via Channels, Natures and Devices as well as the execution of control algorithms via Scheduler and Controllers.

.Architecture scheme 
image::device-nature-channel-scheduler-controller.png[Architecture scheme]
image::device-nature-channel-scheduler-controller.png[Architecture scheme]

=== Configuration

OpenEMS Edge and Backend are configured using the standard OSGi configuration admin service. The easiest way to set a configuration is via the http://localhost:8080/system/console/configMgr[Apache Felix Web Console Configuration icon:external-link[]] as described in the <<_getting_started>> guide above.

.Apache Felix Web Console Configuration
image::apache-felix-console-configuration.png[Apache Felix Web Console Configuration]

Configuration via OpenEMS UI is currently not available due to the ongoing <<_migration_to_osgi>>. Once migration is finished, it is going to be possible to change every configuration using the settings menu in OpenEMS UI - directly to OpenEMS Edge and via Backend.

.OpenEMS UI Configuration
image::ui-config.png[OpenEMS UI Configuration]

=== Hardware

This chapter covers hardware related topics around OpenEMS Edge.
It describes how physical hardware is abstracted using _Natures_, how standardized physical connection layers and protocols are implemented using _Bridges_ and shows which _Devices and Services_ are implemented. The chapter concludes with a development tutorial on how to implement a device. 

==== Natures

Physical hardware is abstracted in OpenEMS Edge using _Natures_. A Nature defines a set of characteristics and attributes which need to be provided by each OpenEMS component that implements it. These characteristics are defined by Channels. For example an implementation of an `Ess` (Energy Storage System), needs to provide an `Soc`-Channel (State of charge of the battery).

Technically Natures are implemented as OSGi API Bundles.

===== ESS (Energy Storage System)

An Energy Storage System is an integrated system with battery and battery inverter.

link:../io.openems.edge.ess.api/src/io/openems/edge/ess/api/Ess.java[Ess icon:code[]]::
A generic Energy Storage System
+
|===
include::_include/nature/Ess.adoc[tag=channels]
|===

link:../io.openems.edge.ess.api/src/io/openems/edge/ess/symmetric/readonly/api/SymmetricEssReadonly.java[SymmetricEssReadonly icon:code[]]::
A symmetric Energy Storage System in readonly-mode.
// TODO add channels

link:../io.openems.edge.ess.api/src/io/openems/edge/ess/symmetric/api/SymmetricEss.java[SymmetricEss icon:code[]]::
A symmetric, controllable Energy Storage System.
// TODO add channels

// TODO: describe SymmetricPower 'Active/Reactive Power circle' + callback

link:../io.openems.edge.ess.api/src/io/openems/edge/ess/dccharger/api/EssDcCharger.java[EssDcCharger icon:code[]]::
A solar charger that is connected to DC side of an energy storage system. 
// TODO add channels

===== Meter

link:../io.openems.edge.meter.api/src/io/openems/edge/meter/api/Meter.java[Meter icon:code[]]::
A generic electric power meter.
// TODO add channels

link:../io.openems.edge.meter.api/src/io/openems/edge/meter/symmetric/api/SymmetricMeter.java[SymmetricMeter icon:code[]]::
A power meter for symmetric metering.
// TODO add channels

link:../io.openems.edge.meter.api/src/io/openems/edge/meter/asymmetric/api/AsymmetricMeter.java[AsymmetricMeter icon:code[]]::
A power meter for asymmetric metering.
// TODO add channels

===== EVCS (Electric Vehicle Charging Station)

link:../io.openems.edge.evcs.api/src/io/openems/edge/evcs/api/Evcs.java[Evcs icon:code[]]::
A charging station for electric vehicles like e-cars and e-buses.
// TODO add channels

===== I/O (Digital Input/Output)

link:../io.openems.edge.io.api/src/io/openems/edge/io/api/DigitalOutput.java[DigitalOutput icon:code[]]::
One or more digital outputs or relays. 
// TODO add channels

==== Bridges

To simplify the implementation of hardware that is connected via certain standardized physical connection layers and protocols, those are implemented as Bridges. 

===== Modbus/TCP

link:../io.openems.edge.bridge.modbus/src/io/openems/edge/bridge/modbus/BridgeModbusTcp.java[Modbus/TCP icon:code[]]::
https://en.wikipedia.org/wiki/Modbus[Modbus/TCP icon:external-link[]] is a widely used standard for fieldbus connections via TCP/IP network. It is used by all kinds of hardware devices like photovoltaics inverters, electric meters, and so on.
// TODO add configuration settings

===== Modbus/RTU

link:../io.openems.edge.bridge.modbus/src/io/openems/edge/bridge/modbus/BridgeModbusSerial.java[Modbus/Serial icon:code[]]::
https://en.wikipedia.org/wiki/Modbus[Modbus/RTU icon:external-link[]] is a widely used standard for fieldbus connections via RS485 serial bus. It is used by all kinds of hardware devices like photovoltaics inverters, electric meters, and so on.
// TODO add configuration settings

==== Devices & Services

// == KEBA KeContact

// The KEBA KeContact bridge is an implementation of the UDP protocol for KEBA KeContact electric vehicle charging stations. It has no specific configuration in itself, as the configuration is happening in the DeviceNature.

// OpenEMS configuration:
// [source,json]
// ----
// {
// 	"class": "io.openems.impl.protocol.keba.KebaBridge",
// 	"devices": [
// 		... <1>
// 	]
// }
// ----
// <1> Configuration of KEBA deviceNatures (see below)

// Implementation: link:../edge/src/io/openems/impl/protocol/keba/KebaBridge.java[io.openems.impl.protocol.keba.KebaBridge icon:code[]]
